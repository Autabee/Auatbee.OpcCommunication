@using Autabee.Utility.Logger
@using Autabee.OpcScoutApp.Controller;
@using Opc.Ua
@inject IAutabeeLogger logger
<div class="@NodeClassType" style="padding-left:@depthString;">
  @if (ScannedNodeModel.RetrievedChildren
    && ScannedNodeModel.Children.Length == 0
    || ScannedNodeModel.Node.NodeClass == NodeClass.Method)
  {
      <span class="node-caret"></span>
  }
  else if (ScannedNodeModel.open)
  {
      <span class="node-caret caret-down" @onclick="Close" />
  }
  else if (!openedOnce || !ScannedNodeModel.RetrievedChildren)
  {
      <span class="node-caret caret" @onclick="Open" />
  }
  else
  {
      <span class="node-caret caret-close" @onclick="Open" />

  }
    <div class="node-img" style="grid-area:node-img; height:100%">
        <NodeImage Value="ScannedNodeModel.NodeImage" />
    </div>
    <span class="node-text" style="grid-area:node-text">@ScannedNodeModel.Node.DisplayName</span>
    <div class="node-actions" style="grid-area:node-actions">

        <button @onclick="()=>ReadNode()" title="read node settings"><icon class="mdi mdi-tag-text" /></button>
    @if (ScannedNodeModel.GetNodeClass() == NodeClass.Variable)
    {
        <button @onclick="()=>ReadValue()" title="read node value"><icon class="mdi mdi-tag-arrow-left" /></button>
    }
    </div>
</div>
@if (ScannedNodeModel.open)
{
  @for (var i = 0; i < ScannedNodeModel.Children.Length; i++)
  {
    <ScannedNodeItem ScannedNodeModel="@(ScannedNodeModel.Children[i])" depth="@depthNext" Browser="@Browser" />
  }
}

@code {
  [Parameter]
  public ScannedNodeModel ScannedNodeModel { get; set; }
  [Parameter]
  public int depth { get; set; }
  [Parameter]
  public NodeBrowserModel Browser { get; set; }
  public string NodeClassType { get; set; } = "Node";

  public int depthNext { get => depth + 1; }


  public string depthString { get => (depth * 8).ToString() + "px"; }
  private bool openedOnce { get; set; }
  protected override void OnInitialized()
  {

    base.OnInitialized();
    ScannedNodeModel.DoneGettingChildren += UpdateChildState;
    ScannedNodeModel.deSelect += DeSelect;
    if (!ScannedNodeModel.RetrievedChildren && !ScannedNodeModel.RetrievingChildren)
    { ScannedNodeModel?.GetChildren(); }
  }

  private void UpdateChildState(object sender, EventArgs args)
  {
    //ScannedNodeModel.Open();
    this.InvokeAsync(delegate { StateHasChanged(); });
  }
  private async void Open()
  {
    if (!ScannedNodeModel.RetrievedChildren && !ScannedNodeModel.RetrievingChildren)
    { ScannedNodeModel?.GetChildren(); }
    ScannedNodeModel.Open();
    if (ScannedNodeModel.open) openedOnce = true;
  }
  private async void Close()
  {
    ScannedNodeModel.Close();
  }

  private async void ReadValue()
  {
    try
    {
      var data = ScannedNodeModel.Client.ReadValue(ScannedNodeModel.Reference.NodeId);
      if (data == null) logger.Information("Read {0} : {1}", null, ScannedNodeModel.Node, "NULL");
      else if (data is object[] list) Array.ForEach(list, x => logger.Information("Read {0} : {1}", null, ScannedNodeModel.Node, x?.ToString()));
      else logger.Information("Read {0} : {1}", null, ScannedNodeModel.Node, data?.ToString());
    }
    catch (Exception e)
    {
      logger.Error(" {0} : {1}", e, ScannedNodeModel.Node, e.Message);
    }
    //NodeClassType = "Node-Selected Node";
    //StateHasChanged();
  }

  private async void ReadNode()
  {

    Browser.UpdateSelected(ScannedNodeModel);
    NodeClassType = "Node-Selected Node";
    StateHasChanged();
  }

  private async void DeSelect(object sender, EventArgs data)
  {
    NodeClassType = "Node";
    StateHasChanged();
  }
}
